### migrations/schema.init.sql

#### 1. Название таблицы
- **Замечание:** Название таблицы `products` слишком общее.
- **Рекомендация:** Добавить префикс проекта, например, `rk_products`, чтобы уменьшить вероятность атак, и для группировки таблиц в рамках одного приложения в БД.

#### 2. Хранение категории в виде строки
- **Замечание:** В таблице `products` и методах репозитория категория представлена строкой.
- **Рекомендация:** Выделить категорию в отдельную таблицу `rk_categories`, использовать `category_id` как внешний ключ.

#### 3. Поле `name` (тип услуги)
- **Замечание:** Использован тип `TEXT`, что избыточно и неэффективно.
- **Рекомендация:** Заменить на `VARCHAR(100)` — достаточно для названия и позволит индексировать поле.

#### 4. Поле `price`
- **Замечание:** Использован тип `FLOAT`, который не гарантирует точность.
- **Рекомендация:** Заменить на `DECIMAL(10,2)` для корректной работы с денежными значениями.

#### 5. Поле `uuid`
- **Замечание:** Отсутствует ограничение уникальности.
- **Рекомендация:** Добавить `UNIQUE`, так как `uuid` должен быть уникальным для каждого товара.

#### 6. Индекс `is_active_idx`
- **Замечание:** Хорошо, что есть индекс, но можно улучшить название и сделать его составным.
- **Рекомендация:** Переименовать в `idx_rk_products_is_active`. Так как фильтрация будет по `is_active` и `category_id`, предлагаю сделать составной индекс по этим полям.

### ProductsView.php, ProductRepository.php, Product.php

#### 7. Уязвимость SQL-инъекции
- **Замечание:** В методе `getByUuid` используется конкатенация строки.
- **Рекомендация:** Использовать `fetchAssociative` с параметрами.

#### 8. Неинформативное исключение
- **Замечание:** Бросается `Exception('Product not found')`.
- **Рекомендация:** Уточнить сообщение: `Product with uuid "{$uuid}" not found`.

#### 9. Неполный SELECT-запрос
- **Замечание:** В `getByCategory()` выбирается только `id`, а создаётся полный объект `Product`.
- **Рекомендация:** Заменить `SELECT id` на `SELECT *`.

#### 10. Преобразование Product в массив
- **Замечание:** В `ProductsView` идёт ручное преобразование сущности в массив.
- **Рекомендация:** Добавить метод `toArray()` в `Product`.

#### 11. Видимость метода `make`
- **Замечание:** Метод `make()` используется только внутри класса.
- **Рекомендация:** Сделать его `private`.

#### 12. Приведение типов в методе `make`
- **Рекомендация:** Явное приведение типов (int, float, bool) необходимо, т.к. данные из БД могут вернуться строками (string).

#### 13. Сортировка результата
- **Замечание:** Список товаров не отсортирован.
- **Рекомендация:** Добавить `ORDER BY name ASC` или по другой логике.

---

### Cart.php, CartItem.php, CartView.php, Customer.php

#### 14. Сериализация в `toArray()`
- **Замечание:** Преобразование объектов в массив производится вручную в `CartView`, что нарушает принцип единой ответственности.
- **Рекомендация:** Реализовать методы `toArray()` в доменных сущностях (`Cart`, `CartItem`, `Customer`) и вызывать их в `CartView`.

#### 15. Метод `Customer::getFullName()`
- **Замечание:** Формирование ФИО клиента реализовано прямо в `CartView`.
- **Рекомендация:** Вынести эту логику в метод `getFullName()` в классе `Customer` — это улучшает читаемость и соблюдает инкапсуляцию.

#### 16. Накопительный `total` в `CartView`
- **Замечание:** Переменная `$total` увеличивается в цикле, и её значение записывается в каждый товар как `total`, что неправильно.
- **Рекомендация:** Для каждой позиции использовать `price * quantity` (отдельный метод `getTotal()`), а общий `total` подсчитывать отдельно через `Cart::getTotal()`.

#### 17. Нарушение принципа единой ответственности (SRP)
- **Замечание:** `CartView` содержит логику подсчёта, преобразования и представления.
- **Рекомендация:** Делегировать бизнес-логику объектам предметной области. `CartView` должен просто собирать данные и отдавать массив.

#### 18. Инкапсуляция в `CartItem`
- **Замечание:** Поля в `CartItem` были объявлены как `public`, несмотря на наличие геттеров.
- **Рекомендация:** Использовать `private readonly` и доступ только через методы, для единообразия и инкапсуляции.

#### 19. Отсутствие метода `getTotal()` в `CartItem`
- **Замечание:** В нескольких местах дублировалась логика `price * quantity`.
- **Рекомендация:** Добавить метод `getTotal()` в `CartItem` и использовать его в `toArray()` и других местах.

#### 20. Читаемость выходных данных
- **Замечание:** В массиве сериализованной корзины использовались промежуточные технические поля, например, `product_uuid`.
- **Рекомендация:** После внедрения полной информации о продукте удалять лишние поля и отдавать только необходимые данные в сериализованном ответе.

---

### AddToCartController.php, GetCartController.php, GetProductsController.php

#### 21. Улучшение читаемости `GetCartController::get()`
- **Замечание:** Дублируется логика возврата ответа в `if/else`.
- **Рекомендация:** Использовать ранний `return` и метод `json()` для упрощения кода.

#### 22. Отсутствие поля `status` в `GetCartController`
- **Замечание:** При успешном и неуспешном ответе отсутствует флаг `status`.
- **Рекомендация:** Возвращать структуру:
  ```json
  {
    "status": "success",
    "cart": { ... }
  }
  ```

#### 23. Необработанное исключение при отсутствии товара
- **Замечание:** Метод `ProductRepository::getByUuid()` выбрасывает исключение при отсутствии товара, но в контроллере оно не перехватывалось.
- **Рекомендация:** Добавить обработку исключения и вернуть понятный ответ с кодом 404.

#### 24. Дублирование сериализации
- **Замечание:** Везде повторяется JSON + заголовки.
- **Рекомендация:** Вынести общую логику ответа (например, метод `json(array $data, int $status): ResponseInterface`) в базовый контроллер или хелпер.

---

### CartManager

#### 25. Неинформативное логирование ошибок
- **Замечание:** В `CartManager::saveCart()` и `CartManager::getCart()` используется `$this->logger->error('Error')`
- **Рекомендация:** Заменить на логирование с сообщением и трассировкой стека
  ```php
  $this->logger->error('Failed to save cart', [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
  ]);
  ```

#### 26. Нарушение логики `CartManager::getCart()`
- **Замечание:** При любой ошибке создаётся новая корзина, даже если Redis недоступен.
- **Рекомендация:** Теперь при ошибке подключения (ConnectorException) метод логирует ошибку и возвращает null, не создавая корзину, как и требовалось.

#### 27. Публичное свойство `$logger`
- **Замечание:** Свойство объявлено `public`, что нарушает инкапсуляцию.
- **Рекомендация:** Сделать `private` и внедрять через конструктор или метод `setLogger`.

#### 28. Магическое число в конструкторе
- **Замечание:** Используется `1` без объяснения в `parent::__construct`.
- **Рекомендация:** Вынести в константу, например:
  ```php
  private const REDIS_CART_DB_INDEX = 1;
  ```

#### 29. Жёстко заданное время жизни (TTL)
- **Замечание:** TTL 24 часа захардкожен.
- **Рекомендация:** Вынести в константу, например:
  ```php
  private const REDIS_CART_TTL_SECONDS = 60 * 60 * 24;
  ```

---

### ConnectorFacade.php
**Проблемы:**
- Нет строгих типов для $host, $port, $password
- Использовался `isConnected()` и `ping()` до `connect()` — нарушает логику Redis.
- Исключения, возникающие при подключении к Redis (RedisException), не логируются.
- Переменные без доступа (`public`) могут быть перезаписаны извне.
- Вызов `build()` происходит вне конструктора, что может привести к вызовам без логгера.

**Решения:**
- Переписать `build()` с корректной последовательностью подключения.
- Ввести обязательный параметр `LoggerInterface $logger` в конструктор для логирования ошибок.
- Использовать строгие типы параметров и возвращаемых значений.
- Вынести `Connector` только после успешного подключения.
- Переместить вызов `build()` в конструктор после инициализации всех зависимостей.

---

### Connector.php
**Проблемы:**
- Неверный тип аргумента `$key` в `get()`.
- Конструктор возвращает значение (!).
- Сериализация без `allowed_classes` — потенциальная уязвимость.
- TTL зашит хардкодом.
- Метод get() не проверяет, что возвращённый объект действительно Cart.

**Решения:**
- Привести аргументы к нужным типам.
- TTL вынести в параметр.
- Безопасная десериализация с указанием допустимых классов.
- Удалить `return` из конструктора.
- Добавить метод `Cart::fromArray`

---

### ConnectorException.php
**Проблемы:**
- Класс заявлен как `implements Throwable`, но не является исключением.
- Вызывал бы `TypeError` при выбрасывании.

**Решения:**
- Наследовать от `\Exception`.

---